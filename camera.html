<!DOCTYPE html>
<html>
<head>
  <title>Chair Squat Counter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>

  <style>
    body { margin:0; background:#111; color:white; font-family:Arial; text-align:center; }
    .header { font-size:22px; padding:10px; }
    .counter { font-size:72px; color:#00ff99; }
    .status { font-size:20px; color:#ffd700; }
    .container { position:relative; }
    video, canvas { width:100%; max-height:55vh; }
    canvas { position:absolute; left:0; top:0; }
    button { margin:10px; padding:12px 25px; font-size:18px; background:red; color:white; border:none; border-radius:8px; }
  </style>
</head>

<body>
  <div class="header">Chair Squat</div>
  <div class="counter" id="count">0</div>
  <div class="status" id="status">Stand straight</div>

  <div class="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
  </div>

  <button onclick="closeExercise()">Close</button>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const countText = document.getElementById("count");
const statusText = document.getElementById("status");

let count = 0;
let stage = "up";

function calculateAngle(a, b, c) {
  const ab = Math.hypot(a.x - b.x, a.y - b.y);
  const bc = Math.hypot(b.x - c.x, b.y - c.y);
  const ac = Math.hypot(a.x - c.x, a.y - c.y);
  return Math.acos((ab*ab + bc*bc - ac*ac) / (2*ab*bc)) * (180 / Math.PI);
}

const pose = new Pose({ locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
pose.setOptions({ modelComplexity:1, smoothLandmarks:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });

pose.onResults(results => {
  if(!results.poseLandmarks) return;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color:"#00FF00", lineWidth:4});
  drawLandmarks(ctx, results.poseLandmarks, {color:"#FF0000", lineWidth:2});

  // LEFT LEG landmarks
  const hip = results.poseLandmarks[23];
  const knee = results.poseLandmarks[25];
  const ankle = results.poseLandmarks[27];

  const angle = calculateAngle(hip, knee, ankle);

  // STAGE LOGIC
  if(angle < 140 && stage === "up") {
    stage = "down";
  }
  if(angle > 165 && stage === "down") {
    stage = "up";
    count++;
    countText.innerText = count;
  }

  statusText.innerText = `Angle: ${angle.toFixed(0)} | Stage: ${stage}`;
});

const camera = new Camera(video, { onFrame: async()=>{await pose.send({image:video})}, width:640, height:480 });
camera.start();

function closeExercise(){ window.location.href="index.html"; }
</script>
</body>
</html>
