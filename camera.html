<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chair Squat</title>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: black;
}

video, canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
}

#ui {
  position: fixed;
  top: 10px;
  width: 100%;
  text-align: center;
  z-index: 5;
  color: white;
  font-family: Arial;
}

#count {
  font-size: 60px;
  font-weight: bold;
}

button {
  margin-top: 10px;
  font-size: 22px;
  padding: 10px 25px;
  border-radius: 8px;
  border: none;
  background: red;
  color: white;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>

<div id="ui">
  <div id="count">0</div>
  <button onclick="stopExercise()">STOP</button>
</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let count = 0;
let stage = "up";
let active = true;
let target = 5;

// ðŸ”º ANGLE FUNCTION
function angle(a, b, c) {
  const ab = { x: a.x - b.x, y: a.y - b.y };
  const cb = { x: c.x - b.x, y: c.y - b.y };
  const dot = ab.x * cb.x + ab.y * cb.y;
  const magAB = Math.hypot(ab.x, ab.y);
  const magCB = Math.hypot(cb.x, cb.y);
  return Math.acos(dot / (magAB * magCB)) * 180 / Math.PI;
}

// ðŸ”¹ MediaPipe Pose
const pose = new Pose({
  locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
});

pose.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  enableSegmentation: false,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

// ðŸ” RESULTS
pose.onResults(results => {
  if (!active) return;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

  if (!results.poseLandmarks) return;

  // ðŸ‘‰ RIGHT LEG (STABLE)
  const hip = results.poseLandmarks[24];
  const knee = results.poseLandmarks[26];
  const ankle = results.poseLandmarks[28];

  const a = angle(hip, knee, ankle);

  if (a < 150 && stage === "up") stage = "down";
  if (a > 165 && stage === "down") {
    stage = "up";
    count++;
    document.getElementById("count").innerText = count;

    if (count >= target) finish();
  }

  drawLandmarks(ctx, results.poseLandmarks, { color: "#00FF00", lineWidth: 3 });
  drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, { color: "#00FF00" });
});

// ðŸŽ¥ CAMERA
const camera = new Camera(video, {
  onFrame: async () => {
    await pose.send({ image: video });
  },
  width: 640,
  height: 480,
  facingMode: "environment" // BACK CAMERA
});

camera.start();

// ðŸ›‘ STOP
function stopExercise() {
  active = false;
  camera.stop();
  location.href = "exercise.html";
}

// âœ… COMPLETE
function finish() {
  active = false;
  camera.stop();
  document.getElementById("count").innerText = "âœ” DONE";
  setTimeout(() => location.href = "exercise.html", 1500);
}
</script>

</body>
</html>
