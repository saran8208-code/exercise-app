<!DOCTYPE html>
<html>
<head>
  <title>Chair Squat (Real Detection)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>

  <style>
    body { margin:0; background:#111; color:white; font-family:Arial; text-align:center; }
    .counter { font-size:72px; color:#00ff99; }
    .status { font-size:20px; color:#ffd700; }
    video, canvas { width:100%; max-height:55vh; }
    canvas { position:absolute; left:0; top:0; }
    .container { position:relative; }
  </style>
</head>

<body>

<h2>Chair Squat</h2>
<div class="counter" id="count">0</div>
<div class="status" id="status">Stand still</div>

<div class="container">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const countText = document.getElementById("count");
const statusText = document.getElementById("status");

let count = 0;
let stage = "up";

// STATE FLAGS
let ready = false;
let exerciseStarted = false;

// FRAME COUNTERS
let standFrames = 0;
let downFrames = 0;

// CONSTANTS (IMPORTANT)
const STAND_ANGLE = 165;
const DOWN_ANGLE = 145;
const STAND_FRAMES_REQUIRED = 30; // ~1 second
const DOWN_FRAMES_REQUIRED = 15;  // ~0.5 second

function angle(a,b,c){
  const ab=Math.hypot(a.x-b.x,a.y-b.y);
  const bc=Math.hypot(b.x-c.x,b.y-c.y);
  const ac=Math.hypot(a.x-c.x,a.y-c.y);
  return Math.acos((ab*ab+bc*bc-ac*ac)/(2*ab*bc))*180/Math.PI;
}

const pose = new Pose({
  locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
});

pose.setOptions({
  modelComplexity:1,
  smoothLandmarks:true,
  minDetectionConfidence:0.5,
  minTrackingConfidence:0.5
});

pose.onResults(res=>{
  if(!res.poseLandmarks) return;

  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // ONLY LEGS
  const l=res.poseLandmarks;
  const angleL = angle(l[23],l[25],l[27]);
  const angleR = angle(l[24],l[26],l[28]);
  const kneeAngle = (angleL+angleR)/2;

  // ---------- GATE 1: STAND STILL ----------
  if(!ready){
    if(kneeAngle > STAND_ANGLE){
      standFrames++;
      statusText.innerText="Stand still...";
      if(standFrames>=STAND_FRAMES_REQUIRED){
        ready=true;
        statusText.innerText="Ready. Do squat";
      }
    } else {
      standFrames=0;
    }
    return;
  }

  // ---------- GATE 2: REAL SQUAT ----------
  if(!exerciseStarted){
    if(kneeAngle < DOWN_ANGLE){
      downFrames++;
      statusText.innerText="Squat detected...";
      if(downFrames>=DOWN_FRAMES_REQUIRED){
        exerciseStarted=true;
        stage="down";
        statusText.innerText="Exercise started!";
      }
    } else {
      downFrames=0;
    }
    return;
  }

  // ---------- COUNTING ----------
  if(kneeAngle < DOWN_ANGLE && stage==="up"){
    stage="down";
  }

  if(kneeAngle > STAND_ANGLE && stage==="down"){
    stage="up";
    count++;
    countText.innerText=count;
  }

  statusText.innerText=`Angle ${kneeAngle.toFixed(0)} | Count ${count}`;
});

const camera=new Camera(video,{
  onFrame:async()=>{await pose.send({image:video});},
  width:640,height:480
});
camera.start();
</script>

</body>
</html>
